name: Test @consciousness/synapse

on:
  workflow_dispatch:
    inputs:
      enable_auto_commit:
        description: 'Enable automatically commit and push changes.'
        default: 'false'
        type: boolean
  schedule:
    # Run every 4 hours at minute 0
    # At ~5 min per run, this uses ~90 minutes/month, well within GitHub's free tier limit (2000 minutes/month)
    - cron: '0 */4 * * *'

# Ensure only one instance of this workflow is active at a time due to file I/O.
concurrency:
  group: synapse-workflow
  cancel-in-progress: true

# Allow workflow to write to the repository, i.e. pushing changes to main branch.
permissions:
  contents: write

jobs:
  test-synapse:
    runs-on: ubuntu-24.04
    timeout-minutes: 15
    
    steps:
 
    - name: Install Ollama
      run: curl -fsSL https://ollama.com/install.sh | sh

    # Start Ollama server in the background. Then it will be ready for use in subsequent steps.
    - name: Start Ollama
      run: |
        ollama serve &
        for i in {1..30}; do
          if ollama list > /dev/null 2>&1; then
            echo "Ollama is running"
            exit 0
          fi
          sleep 1
        done
        echo "Failed to start Ollama"
        exit 1

    # Setup Synapse
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install dependencies
      working-directory: ./synapse
      run: npm install

    - name: Build Synapse
      working-directory: ./synapse
      run: npm run build

    # Let the world burn
    - name: Run Synapse
      working-directory: ./synapse
      run: npm run start
      env:
        # Enable auto-commit for scheduled runs, otherwise use the input value
        ENABLE_AUTO_COMMIT: ${{ github.event_name == 'schedule' || inputs.enable_auto_commit }}
        ENABLE_FILE_WRITE: 'true' # We generally want file writing to be enabled in this workflow.
        ENABLE_GIT_BOT_AUTHOR: 'true' # User email/name for git setup is required for auto-committing to work, so we enable it by default in this workflow.